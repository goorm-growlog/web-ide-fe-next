# í˜‘ì—… ì—ë””í„° ì•„í‚¤í…ì²˜ - ì›¹ì†Œì¼“ê³¼ HocusPocus ì—°ê²° êµ¬ì¡°

## ğŸ—ï¸ ì „ì²´ ì•„í‚¤í…ì²˜ ê°œìš”

ì´ í”„ë¡œì íŠ¸ëŠ” **Next.js + Monaco Editor + Yjs + HocusPocus**ë¥¼ í™œìš©í•œ ì‹¤ì‹œê°„ í˜‘ì—… ì½”ë“œ ì—ë””í„°ì…ë‹ˆë‹¤. HocusPocus Providerë¥¼ í†µí•´ ë°±ì—”ë“œ ì›¹ì†Œì¼“ ì„œë²„ì™€ ì—°ê²°ë˜ì–´ ì‹¤ì‹œê°„ ë¬¸ì„œ ë™ê¸°í™”ì™€ í˜‘ì—… ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

```
Frontend (Next.js)
â”œâ”€â”€ Monaco Editor UI
â”œâ”€â”€ Yjs Document (CRDT)
â”œâ”€â”€ HocusPocus Provider (WebSocket Client)
â””â”€â”€ WebSocket Pool Manager
                â†• WebSocket Connection
Backend WebSocket Server
â”œâ”€â”€ HocusPocus Server
â”œâ”€â”€ Room Management (project-{projectId}-{fileId})
â””â”€â”€ Yjs Document Synchronization
```

## ğŸ“ í•µì‹¬ íŒŒì¼ë³„ ì—­í•  ë¶„ì„

### 1. ì›¹ì†Œì¼“ ì—°ê²° ê´€ë¦¬ì¸µ

#### `src/features/editor/model/websocket-pool.ts`

**ì—­í• **: ì›¹ì†Œì¼“ ì—°ê²°ì˜ ì „ì²´ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•˜ëŠ” ì‹±ê¸€í†¤ í’€ ë§¤ë‹ˆì €

**ì£¼ìš” ê¸°ëŠ¥**:

- **LRU ê¸°ë°˜ íƒ­ ê´€ë¦¬**: ìµœëŒ€ 5ê°œ íƒ­ê¹Œì§€ ë™ì‹œ ì—°ê²° í—ˆìš©
- **ì—°ê²° í’€ë§**: HocusPocus Provider ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
- **Room ë„¤ì´ë°**: `project-{projectId}-{fileId}` í˜•ì‹ìœ¼ë¡œ ë°±ì—”ë“œ ë£¸ê³¼ ë§¤ì¹­

**ë°±ì—”ë“œ ì—°ê²° ì„¤ì •**:

```typescript
private wsUrl = process.env.NEXT_PUBLIC_YJS_WEBSOCKET_URL || "ws://localhost:3001";

const provider = new HocuspocusProvider({
  url: this.wsUrl,           // ë°±ì—”ë“œ ì›¹ì†Œì¼“ URL
  name: roomName,            // project-{projectId}-{fileId}
  document: fileDoc,         // Yjs ë¬¸ì„œ ì¸ìŠ¤í„´ìŠ¤
});
```

**HocusPocus ì—°ê²° íë¦„**:

1. ìƒˆ íŒŒì¼ ì—´ê¸° â†’ `getFileDocument()` í˜¸ì¶œ
2. Y.Doc ìƒì„± (guid: fileId)
3. HocusPocus Provider ìƒì„± ë° ë°±ì—”ë“œ ì—°ê²°
4. `synced` ì´ë²¤íŠ¸ ëŒ€ê¸° â†’ Monaco ëª¨ë¸ ì—…ë°ì´íŠ¸
5. Awareness ì„¤ì • (ì‚¬ìš©ì ì •ë³´ + í™œì„± íŒŒì¼)

#### `src/features/editor/ui/WebSocketCleanup.tsx`

**ì—­í• **: ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ ì›¹ì†Œì¼“ ì—°ê²° ì •ë¦¬

**ì •ë¦¬ ì‹œì **:

- `beforeunload` ì´ë²¤íŠ¸ (ë¸Œë¼ìš°ì € ì¢…ë£Œ/ìƒˆë¡œê³ ì¹¨)
- `unload` ì´ë²¤íŠ¸ (í˜ì´ì§€ ì´íƒˆ)
- ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸

### 2. ì„¸ì…˜ ê´€ë¦¬ì¸µ

#### `src/features/editor/model/useYjsSessionStore.ts`

**ì—­í• **: Yjs ì„¸ì…˜ê³¼ Monaco Editor ëª¨ë¸ì˜ ë°”ì¸ë”© ê´€ë¦¬

**ì„¸ì…˜ ìƒëª…ì£¼ê¸°**:

1. **openSession**: WebSocket Poolì—ì„œ Y.Doc/Provider íšë“ â†’ Monaco ëª¨ë¸ ìƒì„±
2. **connectEditorToSession**: MonacoBinding ìƒì„± (Y.Doc â†” Monaco ì–‘ë°©í–¥ ë™ê¸°í™”)
3. **closeSession**: Binding/Model ì •ë¦¬ + WebSocket Pool ì—°ê²° í•´ì œ

**HocusPocus ë™ê¸°í™” ì²˜ë¦¬**:

```typescript
// ì„œë²„ ë™ê¸°í™” ì™„ë£Œ í›„ Monaco ëª¨ë¸ ì—…ë°ì´íŠ¸ ì½œë°±
(syncedYDoc) => {
  const syncedContent = syncedYDoc.getText("monaco").toString();
  if (session.textModel.getValue() !== syncedContent) {
    session.textModel.setValue(syncedContent);
  }
};
```

### 3. íƒ­ ë° íŒŒì¼ ê´€ë¦¬ì¸µ

#### `src/features/editor/model/use-panes-store.ts`

**ì—­í• **: ì—ë””í„° íƒ­ ìƒíƒœ ê´€ë¦¬ ë° íŒŒì¼ ì—´ê¸°/ë‹«ê¸° ì œì–´

**íƒ­ ê´€ë¦¬ íë¦„**:

- `openFileInEditor`: ì„¸ì…˜ ìƒì„± â†’ íƒ­ ì¶”ê°€ â†’ í™œì„± íƒ­ ì„¤ì •
- `closeTab`: ì„¸ì…˜ ì •ë¦¬ â†’ íƒ­ ì œê±° â†’ ë‹¤ìŒ í™œì„± íƒ­ ì„ íƒ
- `setActiveFileId`: íƒ­ ì „í™˜ ì‹œ ì„¸ì…˜ í™•ì¸ ë° ë³µêµ¬

### 4. ì—ë””í„° ì—°ê²° ê´€ë¦¬ì¸µ

#### `src/features/editor/lib/hooks/useEditorSessionManager.ts`

**ì—­í• **: Monaco Editor ì¸ìŠ¤í„´ìŠ¤ì™€ í™œì„± íŒŒì¼ ì„¸ì…˜ì˜ ì‹¤ì‹œê°„ ì—°ê²° ê´€ë¦¬

**ì—°ê²° ê´€ë¦¬ í”„ë¡œì„¸ìŠ¤**:

1. í™œì„± íŒŒì¼ ë³€ê²½ ê°ì§€
2. ì´ì „ íŒŒì¼ ë·° ìƒíƒœ ì €ì¥ + ì—ë””í„° ì—°ê²° í•´ì œ
3. ìƒˆ íŒŒì¼ ëª¨ë¸ ì„¤ì • + ë°”ì¸ë”© ì—°ê²°
4. Awareness ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
5. ë·° ìƒíƒœ ë³µì›

### 5. ì‹¤ì‹œê°„ í˜‘ì—… UIì¸µ

#### `src/features/editor/cursor/ui/Cursors.tsx`

**ì—­í• **: í˜‘ì—…ìì˜ ì‹¤ì‹œê°„ ì»¤ì„œ ë° ì„ íƒ ì˜ì—­ ì‹œê°í™”

**Awareness ê¸°ë°˜ í˜‘ì—… í‘œì‹œ**:

- HocusPocus Providerì˜ Awareness API í™œìš©
- ê°™ì€ íŒŒì¼ì„ ë³´ëŠ” ì‚¬ìš©ìë§Œ í•„í„°ë§
- ë™ì  CSS ìƒì„±ìœ¼ë¡œ ì‚¬ìš©ìë³„ ì»¤ì„œ ìŠ¤íƒ€ì¼ ì ìš©

## ğŸ”„ HocusPocus ë°±ì—”ë“œ ì—°ê²° íë¦„

### 1. ì—°ê²° ì„¤ì • ë° ì´ˆê¸°í™”

```
[Frontend] websocket-pool.ts
    â†“ new HocuspocusProvider({ url, name, document })
[WebSocket] ws://localhost:3001
    â†“ Room: "project-{projectId}-{fileId}"
[Backend] HocusPocus Server
    â†“ Y.Doc synchronization
[Shared State] Yjs CRDT Document
```

### 2. ì‹¤ì‹œê°„ ë™ê¸°í™” í”„ë¡œì„¸ìŠ¤

```
[User A] Monaco Editor ì…ë ¥
    â†“ MonacoBinding
[Yjs] Y.Text ì—…ë°ì´íŠ¸ (Operation)
    â†“ HocusPocus Provider
[WebSocket] Binary Protocol (Yjs Update)
    â†“ ë°±ì—”ë“œ Room Broadcasting
[WebSocket] â†’ [User B, C, D...]
    â†“ HocusPocus Provider ìˆ˜ì‹ 
[Yjs] Y.Doc ìë™ ë³‘í•© (CRDT)
    â†“ MonacoBinding
[Monaco] Editor ìë™ ì—…ë°ì´íŠ¸
```

### 3. Awareness í˜‘ì—… ì •ë³´ ë™ê¸°í™”

```
[Frontend] setLocalStateField('user', userInfo)
    â†“ HocusPocus Awareness
[WebSocket] JSON Protocol (User State)
    â†“ ë°±ì—”ë“œ Awareness Broadcasting
[Frontend] awareness.on('change', callback)
    â†“ Cursors ì»´í¬ë„ŒíŠ¸
[UI] ì‹¤ì‹œê°„ ì»¤ì„œ/ì„ íƒì˜ì—­ í‘œì‹œ
```

## ğŸ“‹ í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ

### Frontend Dependencies

- **@hocuspocus/provider**: WebSocket ê¸°ë°˜ Yjs Provider
- **yjs**: CRDT ê¸°ë°˜ ì‹¤ì‹œê°„ ë¬¸ì„œ ë™ê¸°í™”
- **y-monaco**: Yjsì™€ Monaco Editor ë°”ì¸ë”©
- **@monaco-editor/react**: Monaco Editor React ì»´í¬ë„ŒíŠ¸
- **zustand**: ìƒíƒœ ê´€ë¦¬

### ì—°ê²° ì„¤ì •

- **WebSocket URL**: `process.env.NEXT_PUBLIC_YJS_WEBSOCKET_URL` (ê¸°ë³¸ê°’: ws://localhost:3001)
- **Room ë„¤ì´ë°**: `project-{projectId}-{fileId}`
- **Document ID**: `fileId` (Y.Doc guid)

## ì„±ëŠ¥ ìµœì í™” ì „ëµ

### 1. ì—°ê²° í’€ë§

- ìµœëŒ€ 5ê°œ íƒ­ ë™ì‹œ ì—°ê²° ì œí•œ
- LRU ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ì˜¤ë˜ëœ ì—°ê²° ìë™ í•´ì œ
- Provider ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš©ìœ¼ë¡œ ë©”ëª¨ë¦¬ ìµœì í™”

### 2. ì„¸ì…˜ ê´€ë¦¬

- íƒ­ ë‹«ê¸° ì‹œ ì¦‰ì‹œ í•´ì œí•˜ì§€ ì•Šê³  ì—°ê²°ë§Œ ëŠì–´ ì¬ì—°ê²° ì‹œ ë¹ ë¥¸ ë³µêµ¬
- MonacoBinding ì§€ì—° ìƒì„± (ì—ë””í„° ì—°ê²° ì‹œì )
- ViewState ìë™ ì €ì¥/ë³µì›ìœ¼ë¡œ ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ

### 3. í˜‘ì—… ìµœì í™”

- ê°™ì€ íŒŒì¼ì„ ë³´ëŠ” ì‚¬ìš©ìë§Œ ì»¤ì„œ í‘œì‹œ í•„í„°ë§
- Awareness ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ ê¸°ë°˜ íš¨ìœ¨ì  UI ì—…ë°ì´íŠ¸
- CSS ë™ì  ìƒì„±ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ DOM ì¡°ì‘ ìµœì†Œí™”
